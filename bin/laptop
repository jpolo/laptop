#!/usr/bin/env bash
# shellcheck source=/dev/null

###
### laptop â€” A tool for maintaining your laptop (cleaning, upgrading, etc)
###
### Usage: laptop [options] <subcommand>
###
### Options:
###   -h,--help: Show this message.
###   -y,--yes:  Skip confirmation prompts and assume yes
###   --color:  Enable or disable ANSI colors (default: auto)
###     - auto: use ANSI colors if available
###     - always: use ANSI colors
###     - never: do not use ANSI colors
###
### Subcommands:

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
ROOT_DIR=$(dirname "$SCRIPT_DIR")

# Path to laptop installation
LAPTOP_HOME=${LAPTOP_HOME:-"$ROOT_DIR"}
# Brew package name (only for brew installation method) example: w5s/tap/laptop
LAPTOP_INSTALL_BREW_PACKAGE=${LAPTOP_INSTALL_BREW_PACKAGE:-""}

# Load laptop library
LAPTOP_LIB_DIR=${LAPTOP_LIB_DIR:-"$LAPTOP_HOME/lib"}
source "$LAPTOP_LIB_DIR/init.sh"
laptop_require "laptop_color_mode"
laptop_require "laptop_die"
laptop_require "laptop_function_exists"

# Change current directory to home (to avoid issues with asdf)
cd "$HOME" || exit 1

###   cleanup: empty cache and prune unused resources
###   config edit <config_type> : edit the configuration file (default: self)
###   config view <config_type> : view the configuration file (default: self)
###   self-upgrade: upgrade only the laptop CLI (Homebrew installs)
###   setup: install and setup every tool for the current profile for this device
###   upgrade: upgrade all tools and packages
###   help: show this message


laptop_command__help() {
  local command="$1"
  if [ -z "$command" ]; then
    sed -rn 's/^### ?//p' "$0"
  else
    man "$LAPTOP_MAN_DIR/laptop-$command.1" 2>/dev/null || {
      laptop_die "Error: No help available for '$command'." >&2
    }
  fi
}

###
### Configuration type:
###   self: laptop configuration file
###   git: git configuration file
###   npm: npm user configuration file (.npmrc)
###   starship: starship configuration file
###   zsh: zsh configuration file
###
### Environment variables:
###   LAPTOP_HOME: Local folder of installation of the laptop executable and library
###   LAPTOP_GIT_REMOTE: Git repository location used as zsh plugin. It can be :
###     - A github repository name (ex: jpolo/laptop)
###     - A full git url (ex: https://github.com/jpolo/laptop.git)
###   LAPTOP_PROFILE: current profile to use for the configure sub command
###     the profile source must be available at `$LAPTOP_HOME/profile/$LAPTOP_PROFILE/profile.sh`

# Parse global options and subcommand
LAPTOP_YES=false
LAPTOP_HELP=false
LAPTOP_SUBCOMMAND=""
LAPTOP_ARGS=()
LAPTOP_BOOTSTRAP=${LAPTOP_BOOTSTRAP:-false}

while [[ $# -gt 0 ]]; do
  case $1 in
    -y|--yes)
      # shellcheck disable=SC2034
      LAPTOP_YES=true
      shift
      ;;
    -h|--help)
      # shellcheck disable=SC2034
      LAPTOP_HELP=true
      shift
      ;;
    --color|--color=*)
      # shellcheck disable=SC2034
      LAPTOP_COLOR_MODE="${1#*=}"
      shift
      if [ "$LAPTOP_COLOR_MODE" = "--color" ]; then
        LAPTOP_COLOR_MODE="$1"
        shift
      fi
      ;;
    -v|--version)
      # shellcheck disable=SC2034
      laptop_command__version
      exit 0
      ;;
    *)
      if [ -z "$LAPTOP_SUBCOMMAND" ]; then
        LAPTOP_SUBCOMMAND=$1
      else
        LAPTOP_ARGS+=("$1")
      fi
      shift
      ;;
  esac
done

# Set the color mode
laptop_color_mode "$LAPTOP_COLOR_MODE"

# Run the program
case $LAPTOP_SUBCOMMAND in
  "" | "help")
    laptop_command__help "${LAPTOP_ARGS[0]}"
    ;;
  "version")
    laptop_command__version
    ;;
  *)
    # Check if help is requested for the subcommand
    if [ "$LAPTOP_HELP" = true ]; then
      laptop_command__help "$LAPTOP_SUBCOMMAND"
      exit 0
    fi

    command_function="laptop_command__${LAPTOP_SUBCOMMAND}"
    command_file="$LAPTOP_LIB_DIR/command/$LAPTOP_SUBCOMMAND.sh"
    if ! laptop_function_exists "$command_function" && [ -f "$command_file" ]; then
      source "$command_file"
    fi
    if ! laptop_function_exists "$command_function"; then
      laptop_die "$(cat <<EOF
'$LAPTOP_SUBCOMMAND' is not a known subcommand. Run '$LAPTOP_APP_NAME --help' for a list of available subcommands
EOF
)"
    fi

    # Call the subcommand
    ${command_function} "${LAPTOP_ARGS[@]}"
    ;;
esac
